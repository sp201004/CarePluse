{"version":3,"file":"wrapMiddlewareWithSentry.js","sources":["../../../src/common/wrapMiddlewareWithSentry.ts"],"sourcesContent":["import {\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n  captureException,\n  getActiveSpan,\n  getCurrentScope,\n  getRootSpan,\n  handleCallbackErrors,\n  setCapturedScopesOnSpan,\n  startSpan,\n  vercelWaitUntil,\n  winterCGRequestToRequestData,\n  withIsolationScope,\n} from '@sentry/core';\nimport type { TransactionSource } from '@sentry/core';\nimport type { EdgeRouteHandler } from '../edge/types';\nimport { flushSafelyWithTimeout } from './utils/responseEnd';\n\n/**\n * Wraps Next.js middleware with Sentry error and performance instrumentation.\n *\n * @param middleware The middleware handler.\n * @returns a wrapped middleware handler.\n */\nexport function wrapMiddlewareWithSentry<H extends EdgeRouteHandler>(\n  middleware: H,\n): (...params: Parameters<H>) => Promise<ReturnType<H>> {\n  return new Proxy(middleware, {\n    apply: async (wrappingTarget, thisArg, args: Parameters<H>) => {\n      // TODO: We still should add central isolation scope creation for when our build-time instrumentation does not work anymore with turbopack.\n      return withIsolationScope(isolationScope => {\n        const req: unknown = args[0];\n        const currentScope = getCurrentScope();\n\n        let spanName: string;\n        let spanSource: TransactionSource;\n\n        if (req instanceof Request) {\n          isolationScope.setSDKProcessingMetadata({\n            normalizedRequest: winterCGRequestToRequestData(req),\n          });\n          spanName = `middleware ${req.method} ${new URL(req.url).pathname}`;\n          spanSource = 'url';\n        } else {\n          spanName = 'middleware';\n          spanSource = 'component';\n        }\n\n        currentScope.setTransactionName(spanName);\n\n        const activeSpan = getActiveSpan();\n\n        if (activeSpan) {\n          // If there is an active span, it likely means that the automatic Next.js OTEL instrumentation worked and we can\n          // rely on that for parameterization.\n          spanName = 'middleware';\n          spanSource = 'component';\n\n          const rootSpan = getRootSpan(activeSpan);\n          if (rootSpan) {\n            setCapturedScopesOnSpan(rootSpan, currentScope, isolationScope);\n          }\n        }\n\n        return startSpan(\n          {\n            name: spanName,\n            op: 'http.server.middleware',\n            attributes: {\n              [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: spanSource,\n              [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.function.nextjs.wrapMiddlewareWithSentry',\n            },\n          },\n          () => {\n            return handleCallbackErrors(\n              () => wrappingTarget.apply(thisArg, args),\n              error => {\n                captureException(error, {\n                  mechanism: {\n                    type: 'instrument',\n                    handled: false,\n                  },\n                });\n              },\n              () => {\n                vercelWaitUntil(flushSafelyWithTimeout());\n              },\n            );\n          },\n        );\n      });\n    },\n  });\n}\n"],"names":["withIsolationScope","getCurrentScope","winterCGRequestToRequestData","getActiveSpan","getRootSpan","setCapturedScopesOnSpan","startSpan","SEMANTIC_ATTRIBUTE_SENTRY_SOURCE","SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN","handleCallbackErrors","captureException","vercelWaitUntil","flushSafelyWithTimeout"],"mappings":";;;;;AAkBA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,wBAAwB;AACxC,EAAE,UAAU;AACZ,EAAwD;AACxD,EAAE,OAAO,IAAI,KAAK,CAAC,UAAU,EAAE;AAC/B,IAAI,KAAK,EAAE,OAAO,cAAc,EAAE,OAAO,EAAE,IAAI,KAAoB;AACnE;AACA,MAAM,OAAOA,uBAAkB,CAAC,cAAA,IAAkB;AAClD,QAAQ,MAAM,GAAG,GAAY,IAAI,CAAC,CAAC,CAAC;AACpC,QAAQ,MAAM,YAAA,GAAeC,oBAAe,EAAE;;AAE9C,QAAQ,IAAI,QAAQ;AACpB,QAAQ,IAAI,UAAU;;AAEtB,QAAQ,IAAI,GAAI,YAAW,OAAO,EAAE;AACpC,UAAU,cAAc,CAAC,wBAAwB,CAAC;AAClD,YAAY,iBAAiB,EAAEC,iCAA4B,CAAC,GAAG,CAAC;AAChE,WAAW,CAAC;AACZ,UAAU,QAAA,GAAW,CAAC,WAAW,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC,EAAE,IAAI,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC,CAAA;AACA,UAAA,UAAA,GAAA,KAAA;AACA,SAAA,MAAA;AACA,UAAA,QAAA,GAAA,YAAA;AACA,UAAA,UAAA,GAAA,WAAA;AACA;;AAEA,QAAA,YAAA,CAAA,kBAAA,CAAA,QAAA,CAAA;;AAEA,QAAA,MAAA,UAAA,GAAAC,kBAAA,EAAA;;AAEA,QAAA,IAAA,UAAA,EAAA;AACA;AACA;AACA,UAAA,QAAA,GAAA,YAAA;AACA,UAAA,UAAA,GAAA,WAAA;;AAEA,UAAA,MAAA,QAAA,GAAAC,gBAAA,CAAA,UAAA,CAAA;AACA,UAAA,IAAA,QAAA,EAAA;AACA,YAAAC,4BAAA,CAAA,QAAA,EAAA,YAAA,EAAA,cAAA,CAAA;AACA;AACA;;AAEA,QAAA,OAAAC,cAAA;AACA,UAAA;AACA,YAAA,IAAA,EAAA,QAAA;AACA,YAAA,EAAA,EAAA,wBAAA;AACA,YAAA,UAAA,EAAA;AACA,cAAA,CAAAC,qCAAA,GAAA,UAAA;AACA,cAAA,CAAAC,qCAAA,GAAA,+CAAA;AACA,aAAA;AACA,WAAA;AACA,UAAA,MAAA;AACA,YAAA,OAAAC,yBAAA;AACA,cAAA,MAAA,cAAA,CAAA,KAAA,CAAA,OAAA,EAAA,IAAA,CAAA;AACA,cAAA,KAAA,IAAA;AACA,gBAAAC,qBAAA,CAAA,KAAA,EAAA;AACA,kBAAA,SAAA,EAAA;AACA,oBAAA,IAAA,EAAA,YAAA;AACA,oBAAA,OAAA,EAAA,KAAA;AACA,mBAAA;AACA,iBAAA,CAAA;AACA,eAAA;AACA,cAAA,MAAA;AACA,gBAAAC,oBAAA,CAAAC,kCAAA,EAAA,CAAA;AACA,eAAA;AACA,aAAA;AACA,WAAA;AACA,SAAA;AACA,OAAA,CAAA;AACA,KAAA;AACA,GAAA,CAAA;AACA;;;;"}