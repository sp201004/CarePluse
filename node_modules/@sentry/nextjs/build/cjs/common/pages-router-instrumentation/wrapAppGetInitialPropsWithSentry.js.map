{"version":3,"file":"wrapAppGetInitialPropsWithSentry.js","sources":["../../../../src/common/pages-router-instrumentation/wrapAppGetInitialPropsWithSentry.ts"],"sourcesContent":["import type App from 'next/app';\n\nimport { isBuild } from '../utils/isBuild';\nimport { withErrorInstrumentation, withTracedServerSideDataFetcher } from '../utils/wrapperUtils';\n\ntype AppGetInitialProps = (typeof App)['getInitialProps'];\n\n/**\n * Create a wrapped version of the user's exported `getInitialProps` function in\n * a custom app (\"_app.js\").\n *\n * @param origAppGetInitialProps The user's `getInitialProps` function\n * @param parameterizedRoute The page's parameterized route\n * @returns A wrapped version of the function\n */\nexport function wrapAppGetInitialPropsWithSentry(origAppGetInitialProps: AppGetInitialProps): AppGetInitialProps {\n  return new Proxy(origAppGetInitialProps, {\n    apply: async (wrappingTarget, thisArg, args: Parameters<AppGetInitialProps>) => {\n      if (isBuild()) {\n        return wrappingTarget.apply(thisArg, args);\n      }\n\n      const [context] = args;\n      const { req, res } = context.ctx;\n\n      const errorWrappedAppGetInitialProps = withErrorInstrumentation(wrappingTarget);\n\n      // Generally we can assume that `req` and `res` are always defined on the server:\n      // https://nextjs.org/docs/api-reference/data-fetching/get-initial-props#context-object\n      // This does not seem to be the case in dev mode. Because we have no clean way of associating the the data fetcher\n      // span with each other when there are no req or res objects, we simply do not trace them at all here.\n      if (req && res) {\n        const tracedGetInitialProps = withTracedServerSideDataFetcher(errorWrappedAppGetInitialProps, req, res, {\n          dataFetcherRouteName: '/_app',\n          requestedRouteName: context.ctx.pathname,\n          dataFetchingMethodName: 'getInitialProps',\n        });\n\n        const {\n          data: appGetInitialProps,\n          sentryTrace,\n          baggage,\n        }: {\n          data?: unknown;\n          sentryTrace?: string;\n          baggage?: string;\n        } = await tracedGetInitialProps.apply(thisArg, args);\n\n        if (typeof appGetInitialProps === 'object' && appGetInitialProps !== null) {\n          // Per definition, `pageProps` is not optional, however an increased amount of users doesn't seem to call\n          // `App.getInitialProps(appContext)` in their custom `_app` pages which is required as per\n          // https://nextjs.org/docs/advanced-features/custom-app - resulting in missing `pageProps`.\n          // For this reason, we just handle the case where `pageProps` doesn't exist explicitly.\n          if (!(appGetInitialProps as Record<string, unknown>).pageProps) {\n            (appGetInitialProps as Record<string, unknown>).pageProps = {};\n          }\n\n          // The Next.js serializer throws on undefined values so we need to guard for it (#12102)\n          if (sentryTrace) {\n            (appGetInitialProps as { pageProps: Record<string, unknown> }).pageProps._sentryTraceData = sentryTrace;\n          }\n\n          // The Next.js serializer throws on undefined values so we need to guard for it (#12102)\n          if (baggage) {\n            (appGetInitialProps as { pageProps: Record<string, unknown> }).pageProps._sentryBaggage = baggage;\n          }\n        }\n\n        return appGetInitialProps;\n      } else {\n        return errorWrappedAppGetInitialProps.apply(thisArg, args);\n      }\n    },\n  });\n}\n"],"names":["isBuild","withErrorInstrumentation","withTracedServerSideDataFetcher"],"mappings":";;;;;AAOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,gCAAgC,CAAC,sBAAsB,EAA0C;AACjH,EAAE,OAAO,IAAI,KAAK,CAAC,sBAAsB,EAAE;AAC3C,IAAI,KAAK,EAAE,OAAO,cAAc,EAAE,OAAO,EAAE,IAAI,KAAqC;AACpF,MAAM,IAAIA,eAAO,EAAE,EAAE;AACrB,QAAQ,OAAO,cAAc,CAAC,KAAK,CAAC,OAAO,EAAE,IAAI,CAAC;AAClD;;AAEA,MAAM,MAAM,CAAC,OAAO,CAAA,GAAI,IAAI;AAC5B,MAAM,MAAM,EAAE,GAAG,EAAE,KAAM,GAAE,OAAO,CAAC,GAAG;;AAEtC,MAAM,MAAM,8BAA+B,GAAEC,qCAAwB,CAAC,cAAc,CAAC;;AAErF;AACA;AACA;AACA;AACA,MAAM,IAAI,GAAI,IAAG,GAAG,EAAE;AACtB,QAAQ,MAAM,qBAAsB,GAAEC,4CAA+B,CAAC,8BAA8B,EAAE,GAAG,EAAE,GAAG,EAAE;AAChH,UAAU,oBAAoB,EAAE,OAAO;AACvC,UAAU,kBAAkB,EAAE,OAAO,CAAC,GAAG,CAAC,QAAQ;AAClD,UAAU,sBAAsB,EAAE,iBAAiB;AACnD,SAAS,CAAC;;AAEV,QAAQ,MAAM;AACd,UAAU,IAAI,EAAE,kBAAkB;AAClC,UAAU,WAAW;AACrB,UAAU,OAAO;AACjB;;AAIQ,GAAI,MAAM,qBAAqB,CAAC,KAAK,CAAC,OAAO,EAAE,IAAI,CAAC;;AAE5D,QAAQ,IAAI,OAAO,kBAAmB,KAAI,YAAY,kBAAA,KAAuB,IAAI,EAAE;AACnF;AACA;AACA;AACA;AACA,UAAU,IAAI,CAAC,CAAC,qBAA+C,SAAS,EAAE;AAC1E,YAAY,CAAC,kBAAmB,GAA4B,SAAU,GAAE,EAAE;AAC1E;;AAEA;AACA,UAAU,IAAI,WAAW,EAAE;AAC3B,YAAY,CAAC,qBAA8D,SAAS,CAAC,gBAAA,GAAmB,WAAW;AACnH;;AAEA;AACA,UAAU,IAAI,OAAO,EAAE;AACvB,YAAY,CAAC,qBAA8D,SAAS,CAAC,cAAA,GAAiB,OAAO;AAC7G;AACA;;AAEA,QAAQ,OAAO,kBAAkB;AACjC,aAAa;AACb,QAAQ,OAAO,8BAA8B,CAAC,KAAK,CAAC,OAAO,EAAE,IAAI,CAAC;AAClE;AACA,KAAK;AACL,GAAG,CAAC;AACJ;;;;"}